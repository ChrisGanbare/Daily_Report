# ZR Daily Report 技术文档

## 1. 项目概述
ZR Daily Report 是一个专门用于生成切削液设备日常库存报告的Python应用程序。主要功能包括数据库查询、Excel报表生成和图表可视化。

## 2. 技术栈
- Python >= 3.8
- openpyxl >= 3.1.0（Excel文件处理）
- mysql-connector-python >= 8.0.26（数据库连接）
- datetime（日期处理）
- pandas（数据处理）

## 3. 文件结构

```
Daily_Report/ 
├── ZR_Daily_Report.py          # 主程序 
├── db_handler.py               # 数据库处理模块
├── excel_handler.py            # Excel处理模块
├── config_handler.py           # 配置处理模块
├── file_handler.py             # 文件处理模块
├── data_validator.py           # 数据验证模块
├── statement_handler.py        # 对账单处理模块
├── date_utils.py               # 日期处理工具 
├── devices_template.csv        # 设备信息模板 
├── query_config.json           # 数据库配置 
├── technical_documentation.md  # 技术文档 
├── test_zr_daily_report.py     # 主测试用例 
├── test_statement_handler.py   # 对账单处理模块测试用例 
└── test_output/                # 测试输出目录 
  ├── test_无效数据测试.xlsx 
  ├── test_空数据测试.xlsx 
  ├── test_缺失数据测试.xlsx 
  └── test_连续数据测试.xlsx
```

## 4. 功能特性
1. 支持多设备批量处理
2. 自动生成库存趋势图表
3. 生成增强版对账单
4. 详细的执行日志
5. 完善的错误处理机制
6. 支持多种日期格式

## 5. 数据库配置

### 5.1 连接信息
- 主机：[加密保护]
- 端口：3306
- 数据库：oil
- 用户：[加密保护]

### 主要查询模板
1. 设备ID查询
2. 库存数据查询
3. 客户信息查询

## 6. 输入要求

### 设备信息文件(CSV)
- 文件编码：UTF-8
- 必需字段：
  - device_no（设备编号）
  - start_date（开始日期）
  - end_date（结束日期）
- 日期格式支持：
  - YYYY-MM-DD
  - YYYY/M/D

## 7. 输出规范

### Excel文件命名
1. 标准格式：`油品名称_设备编码_年月.xlsx`
2. 对账单格式：`客户名称年月对账单.xlsx`

### Excel内容格式
- 字体：Arial/等线
- 数值：保留2位小数
- 日期：YYYY-MM-DD
- 图表：折线图（库存趋势）

## 8. 程序执行流程
1. 读取配置和设备信息
2. 数据库连接与查询
3. 生成Excel报表
4. 保存结果文件

## 9. 错误处理
1. 文件读取错误
2. 数据库连接错误
3. 无效设备信息
4. 日期格式错误
5. 数据查询异常
6. 文件保存错误

## 10. 日志规范
- 格式：程序执行日志_YYYYMMDD_HHMMSS.txt
- 内容分段：
  - 步骤1：配置读取
  - 步骤2：数据库操作
  - 步骤3：报表生成
  - 步骤4：文件保存

## 11. 测试用例
1. 数据验证测试
2. 日期处理测试
3. 图表生成测试
4. 异常处理测试
5. 数据库操作测试
6. 文件处理测试
7. 配置处理测试
8. 对账单处理测试

### 11.1 对账单处理测试用例
针对对账单处理模块设计了以下测试用例：

1. **类名和方法名测试** - 验证类名和方法名是否符合对账单相关要求
2. **模板不存在错误测试** - 测试模板不存在时的错误提示
3. **对账单文件名格式测试** - 测试对账单文件名格式是否正确
4. **必需工作表识别测试** - 测试必需工作表的识别功能
5. **每日用量明细工作表更新测试** - 测试每日用量明细工作表的数据更新
6. **每日用量明细工作表日期字段测试** - 测试每日用量明细工作表的日期字段格式和位置
7. **每日用量明细工作表数据结构测试** - 测试每日用量明细工作表的数据结构是否符合要求
8. **多油品处理测试** - 测试多油品处理功能
9. **动态油品数量处理测试** - 测试根据实际油品数量动态处理列，清除模板中多余的油品列

## 12. 版本历史
| 版本 | 日期 | 更新内容 | 作者 |
|------|------|---------|------|
| 1.0 | 2025-07-14 | 初始版本 | Lingma |
| 1.1 | 2025-08-01 | 数据库功能 | Lingma |
| 1.2 | 2025-08-02 | 测试用例 | Lingma |
| 1.3 | 2025-08-03 | 日期处理优化 | Lingma |
| 1.4 | 2025-08-04 | 图表优化 | Lingma |
| 1.5 | 2025-08-07 | 项目重构，模块化设计 | Lingma |
| 1.6 | 2025-08-07 | 更新测试用例以适配重构后的项目结构 | Lingma |
| 1.7 | 2025-08-07 | 优化对账单生成功能，创建专用处理模块 | Lingma |
| 1.8 | 2025-08-08 | 添加对账单处理模块测试用例 | Lingma |
| 1.9 | 2025-08-08 | 优化动态油品数量处理功能 | Lingma |

## 13. 常见问题
1. 日期格式错误
2. 数据库连接超时
3. 文件权限问题
4. 中文编码问题

## 14. 维护建议
1. 定期备份配置文件
2. 监控数据库连接
3. 检查日志文件大小
4. 更新测试用例

## 15. 部署说明

### 15.1 环境要求
- Python >= 3.8
- pip（Python包管理器）
- Git（版本控制）

### 15.2 安装步骤
1. 克隆代码仓库
```bash
git clone https://github.com/ChrisGanbare/Daily_Report.git
cd Daily_Report
```

2. 创建虚拟环境
python -m venv .venv
.venv\Scripts\activate
3. 安装依赖包
pip install -r requirements.txt

### 15.3 配置文件设置
1. 复制配置模板
```bash
cp query_config_template.json query_config.json
```
2. 修改配置文件 query_config.json 填入实际配置
3. 运行配置加密工具
python encrypt_config.py
4. 确认加密后的配置文件 query_config.json 已正确生成
.env（密钥文件）
query_config_encrypted.json（加密配置）

### 15.4 运行程序
Daily_Report/
├── .env                        # 加密密钥（不要提交到Git）
├── config_encrypt.py          # 配置加密工具
├── query_config.json          # 原始配置（不要提交到Git）
├── query_config_encrypted.json # 加密后的配置
└── query_config_template.json  # 配置模板

## 16 使用说明
### 16.1 准备工作
1.准备设备信息文件
使用 devices_template.csv 作为模板
确保UTF-8编码
填写正确的设备编号和日期范围

2.确认配置文件
检查数据库连接配置
验证SQL模板正确性

### 16.2 运行程序
1.激活虚拟环境
.venv\Scripts\activate
2.运行程序
python ZR_Daily_Report.py
3.生成报表
报表生成完成，结果保存在当前目录下。
4.查看日志
日志保存在当前目录下，文件名为程序执行日志_YYYYMMDD_HHMMSS.txt
5.查看错误  
错误信息保存在当前目录下，文件名为程序错误日志_YYYYMMDD_HHMMSS.txt
6.查看测试用例
测试用例保存在当前目录下，文件名为test_output/test_*.xlsx
7.查看版本历史
版本历史保存在当前目录下，文件名为版本历史.md
8.查看常见问题
常见问题保存在当前目录下，文件名为常见问题.md

### 16.3 安全建议
妥善保管 .env 文件
定期更新加密密钥
不要提交敏感信息到版本控制
定期备份配置文件

## 17 动态油品处理说明

### 17.1 功能描述
对账单处理模块能够根据实际客户设备的油品数量动态调整Excel表格中的列数。如果模板中预设了较多的油品列，而实际客户只有较少的油品，系统会自动清除模板中多余的油品列，只显示实际需要的油品数据。

### 17.2 实现原理
1. 收集所有设备的油品名称
2. 清除模板中可能存在的旧数据（包括表头和数据）
3. 根据实际油品数量重新写入表头和数据
4. 确保只显示与实际油品数量相符的列数

### 17.3 优势
1. 提高模板的通用性 - 一个模板可以适用于不同数量油品的客户
2. 避免显示无用的空列
3. 保证数据展示的整洁性
4. 减少手动调整模板的工作量