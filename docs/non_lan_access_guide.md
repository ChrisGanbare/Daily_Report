# ZR Daily Report 非局域网访问配置指南

## 1. 概述

本文档提供了如何将 ZR Daily Report Web 应用配置为可被非局域网内用户访问的详细指南。通过以下方法，您可以让远程用户访问到部署在本地的应用服务。

## 2. 应用基础配置确认

首先，确认您的应用已正确配置为支持外部访问：

1. 应用已配置为监听所有网络接口 (0.0.0.0)：
   - 检查 `src/main.py` 中的 `uvicorn.run` 配置，确保 `host` 参数设置为 "0.0.0.0"
   - 检查 `src/web/app.py` 中的 `uvicorn.run` 配置，确保 `host` 参数也设置为 "0.0.0.0"

2. 确保 Windows 防火墙允许 8000 端口的入站连接（参考 `web_sharing_instructions.md` 文档中的防火墙配置部分）

## 3. 非局域网访问方案

### 3.1 方案对比

| 方案 | 复杂度 | 成本 | 安全性 | 适用性 |
|------|--------|------|--------|--------|
| 端口转发 | 中 | 低（免费） | 中（需额外安全措施） | 个人/小型团队 |
| 动态DNS + 端口转发 | 中高 | 低至中（部分免费，部分付费） | 中（需额外安全措施） | 个人/小型团队 |
| VPN | 高 | 中（可能需要服务器） | 高 | 企业/对安全性要求高的场景 |
| 云服务部署 | 中 | 中高（需要云服务器） | 中高（取决于配置） | 企业/长期使用 |

## 4. 方案一：端口转发（Port Forwarding）

### 4.1 步骤1：获取公网IP地址

1. 在部署应用的电脑上，打开浏览器访问 [https://www.ip138.com/](https://www.ip138.com/) 或 [https://www.whatismyip.com/](https://www.whatismyip.com/)
2. 记录显示的公网IP地址（如：119.XX.XX.XX）

### 4.2 步骤2：配置路由器端口转发

不同品牌路由器的配置界面有所不同，但基本步骤类似：

1. **登录路由器管理界面**：
   - 通常在浏览器中输入 192.168.0.1 或 192.168.1.1（具体地址见路由器背面标签）
   - 使用管理员账号和密码登录（默认通常是 admin/admin 或 admin/password）

2. **找到端口转发设置**：
   - 常见位置：「高级设置」>「端口转发」、「转发规则」>「虚拟服务器」或「NAT设置」>「端口映射」

3. **添加端口转发规则**：
   - 服务名称：ZR Daily Report
   - 内部IP地址：部署应用电脑的局域网IP地址（如：192.168.1.4）
   - 内部端口：8000
   - 外部端口：8000（也可设置为其他端口，如80或443，但可能需要额外配置）
   - 协议类型：TCP
   - 保存设置

### 4.3 步骤3：测试外部访问

1. **确保应用正在运行**：在本地电脑启动应用
2. **在另一台非局域网设备上**（如使用手机4G网络）打开浏览器
3. **访问**：`http://您的公网IP:8000`（例如：http://119.XX.XX.XX:8000）

### 4.4 注意事项

- 公网IP可能会定期变化（取决于ISP）
- 需要确保路由器不重启或配置不丢失
- 暴露在公网的服务需要额外的安全措施

## 5. 方案二：动态DNS（DDNS）+ 端口转发

解决公网IP可能变化的问题

### 5.1 步骤1：注册动态DNS服务

选择一个DDNS服务提供商：
- **免费选项**：No-IP、DynDNS免费版、花生壳
- **付费选项**：DynDNS Pro、DuckDNS等

以No-IP为例：
1. 访问 [https://www.noip.com/](https://www.noip.com/) 并注册账号
2. 创建一个主机名（如：yourname.ddns.net）

### 5.2 步骤2：配置路由器DDNS

1. 登录路由器管理界面
2. 找到DDNS设置
3. 选择您的DDNS服务提供商
4. 输入您的账号、密码和主机名
5. 保存设置并启用DDNS

### 5.3 步骤3：配置端口转发

按照方案一中的端口转发配置步骤进行设置

### 5.4 步骤4：测试访问

使用DDNS域名访问应用：`http://yourname.ddns.net:8000`

## 6. 方案三：VPN访问

### 6.1 搭建VPN服务器

#### 6.1.1 使用Windows内置VPN功能（简单但功能有限）

1. 打开控制面板 > 网络和Internet > 网络和共享中心
2. 点击「设置新的连接或网络」
3. 选择「连接到工作区」>「下一步」
4. 选择「使用我的Internet连接(VPN)」
5. 输入相关信息并设置用户账户

#### 6.1.2 使用第三方VPN软件（推荐）

**OpenVPN**：
1. 在Windows服务器上安装OpenVPN服务器
2. 配置服务器证书和密钥
3. 设置用户账户
4. 创建客户端配置文件

**WireGuard**：
1. 安装WireGuard服务器
2. 生成服务器和客户端密钥对
3. 配置服务器和客户端

### 6.2 配置VPN客户端

1. 远程用户安装对应的VPN客户端软件
2. 导入或配置VPN连接信息
3. 连接到VPN服务器

### 6.3 访问应用

VPN连接成功后，远程用户可以通过局域网IP访问应用：`http://192.168.1.4:8000`

## 7. 方案四：云服务部署

将应用部署到云服务器上，使任何人都可以通过公网访问。

### 7.1 选择云服务提供商

- 阿里云
- 腾讯云
- AWS
- Azure
- Google Cloud

### 7.2 部署步骤

1. 购买并配置一台云服务器（推荐配置：2核4G内存，Ubuntu或CentOS系统）
2. 在云服务器上安装所需环境（Python 3.8+, pip等）
3. 上传应用代码到云服务器
4. 安装依赖：`pip install -r requirements.txt`
5. 配置环境变量和数据库连接
6. 启动应用（建议使用PM2或Supervisor等进程管理工具）
7. 配置安全组/防火墙，开放8000端口

### 7.3 访问应用

通过云服务器的公网IP或域名访问：`http://云服务器IP:8000`

## 8. 安全注意事项

### 8.1 端口转发和DDNS方案的安全加固

1. **更改默认端口**：不要使用常见端口，如8080，可以改为不常用端口（如：32456）
2. **启用HTTPS**：配置SSL证书，将流量加密
   ```bash
   # 使用Let's Encrypt获取免费证书
   # 需要安装certbot并配置
   ```
3. **添加访问控制**：
   - 在应用中实现身份验证
   - 考虑使用反向代理（如Nginx）添加基本认证
4. **定期更新应用**：确保应用及依赖的安全性
5. **监控访问日志**：定期检查异常访问

### 8.2 防火墙配置

```powershell
# 以管理员身份运行PowerShell

# 允许特定IP访问8000端口（更安全）
New-NetFirewallRule -DisplayName "允许特定IP访问8000端口 (ZR Daily Report)" -Direction Inbound -Protocol TCP -LocalPort 8000 -RemoteAddress 192.168.1.0/24,203.XX.XX.XX -Action Allow

# 或者限制访问频率（使用Windows高级防火墙）
# 这需要配置高级安全Windows防火墙的连接安全规则
```

## 9. 故障排除

### 9.1 无法从外部访问应用

1. **检查应用是否正常运行**：在本地确认应用是否可以通过 http://localhost:8000 访问
2. **检查本地防火墙**：确认Windows防火墙已允许8000端口
3. **检查路由器端口转发**：
   - 验证内部IP地址是否正确
   - 验证端口设置是否正确
   - 确认端口转发规则已启用
4. **检查公网IP是否变化**：如果使用端口转发而不是DDNS，确认公网IP是否已变更
5. **检查ISP是否封锁了端口**：某些ISP会封锁常用端口，尝试更换端口

### 9.2 连接不稳定

1. **检查网络带宽**：确保上传带宽足够
2. **检查路由器性能**：低端路由器可能在高负载下不稳定
3. **考虑使用VPN**：如果ISP限制了某些类型的流量

### 9.3 安全问题

1. **检查异常访问**：审查应用和服务器日志
2. **更新密码和证书**：定期更换访问凭证
3. **使用入侵检测工具**：监控可疑活动

## 10. 结论

根据您的需求和技术能力，选择最合适的非局域网访问方案：

- **个人使用**：端口转发或动态DNS
- **小型团队**：动态DNS + 端口转发或VPN
- **企业应用**：VPN或云服务部署

无论选择哪种方案，请务必注意安全性，采取适当的安全措施保护您的应用和数据。