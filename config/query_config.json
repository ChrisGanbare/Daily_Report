{
    "sql_templates": {
        "device_id_query": "SELECT id, customer_id FROM oil.t_device WHERE device_code = :device_code ORDER BY create_time DESC LIMIT 1",
        "device_id_fallback_query": "SELECT id, customer_id FROM oil.t_device WHERE device_no = %s ORDER BY create_time DESC LIMIT 1",
        "inventory_query": "SELECT a.id AS '订单序号', a.order_time AS '加注时间', a.oil_type_id AS '油品序号', b.oil_model AS '油品名称', a.water AS '水油比：水值', a.oil AS '水油比：油值', a.water_val AS '水加注值', a.oil_val AS '油加注值', a.avai_oil AS '原油剩余量', a.avai_oil / 1000 AS '原油剩余比例', a.oil_set_val AS '油加设量', a.is_settlement AS '是否结算：1=待结算 2=待生效 3=已结算', a.fill_mode AS '加注模式：1=近程自动 2=远程自动 3=手动' FROM oil.t_device_oil_order a LEFT JOIN oil.t_oil_type b ON a.oil_type_id = b.id WHERE a.device_id = '{device_id}' AND a.status = 1 AND a.order_time >= '{start_date}' AND a.order_time < '{end_condition}' ORDER BY a.order_time DESC;",
        "customer_query": "SELECT customer_name FROM oil.t_customer WHERE id = %s",
        "refueling_details_query": "SELECT a.id AS '订单序号', a.order_time AS '加注时间', a.oil_type_id AS '油品序号', b.oil_model AS '油品名称', a.water AS '水油比：水值', a.oil AS '水油比：油值', a.water_val AS '水加注值', a.oil_val AS '油加注值', a.avai_oil AS '原油剩余量', a.avai_oil / 1000 AS '原油剩余比例', a.oil_set_val AS '油加设量', a.is_settlement AS '是否结算：1=待结算 2=待生效 3=已结算', a.fill_mode AS '加注模式：1=近程自动 2=远程自动 3=手动' FROM oil.t_device_oil_order a LEFT JOIN oil.t_oil_type b ON a.oil_type_id = b.id WHERE a.device_id = '{device_id}' AND a.status = 1 AND a.order_time >= '{start_date}' AND a.order_time < '{end_condition}' ORDER BY a.order_time DESC;",
        "daily_consumption_raw_query": "\n        WITH RECURSIVE DateSeries AS (\n            -- 步骤1: 创建一个从开始到结束的完整日期序列\n            SELECT CAST(:start_date_param AS DATE) AS report_date\n            UNION ALL\n            SELECT report_date + INTERVAL 1 DAY\n            FROM DateSeries\n            WHERE report_date < :end_date_param\n        ),\n        LatestDevices AS (\n            -- 步骤2: 找出每个device_code对应的最新的、有效的device_id和oil_type_id\n            SELECT \n                t.id as device_id, \n                t.device_code,\n                t.customer_id,\n                (SELECT oil_type_id FROM t_device_oil_order WHERE device_id = t.id ORDER BY order_time DESC LIMIT 1) as oil_type_id\n            FROM (\n                SELECT \n                    id, \n                    device_code, \n                    customer_id,\n                    ROW_NUMBER() OVER (PARTITION BY device_code ORDER BY create_time DESC, id DESC) as rn\n                FROM t_device\n                WHERE del_status = 1 AND device_code IS NOT NULL AND device_code != ''\n            ) AS t\n            WHERE t.rn = 1\n        ),\n        OrderWithPrevInventory AS (\n            -- 步骤3: 为每条订单记录计算上一条记录的库存\n            SELECT\n                device_id,\n                order_time,\n                oil_val,\n                avai_oil,\n                LAG(avai_oil, 1, avai_oil) OVER (PARTITION BY device_id ORDER BY order_time) AS prev_avai_oil\n            FROM\n                t_device_oil_order\n            WHERE\n                order_time >= :start_date_param_full AND order_time <= :end_date_param_full\n                AND status = 1\n        ),\n        DailyAggregates AS (\n            -- 步骤4: 按天聚合订单量和推断加油量\n            SELECT\n                o.device_id,\n                DATE(o.order_time) AS report_date,\n                SUM(o.oil_val) AS daily_order_volume,\n                SUM(GREATEST(0, o.avai_oil - o.prev_avai_oil)) AS daily_refill\n            FROM\n                OrderWithPrevInventory o\n            JOIN\n                LatestDevices ld ON o.device_id = ld.device_id\n            GROUP BY\n                o.device_id, DATE(o.order_time)\n        ),\n        DailyLastInventory AS (\n            -- 步骤4.1 (并行): 获取每日的最后一次库存记录\n            SELECT\n                device_id,\n                DATE(order_time) AS report_date,\n                avai_oil AS end_of_day_inventory\n            FROM (\n                SELECT\n                    device_id,\n                    order_time,\n                    avai_oil,\n                    ROW_NUMBER() OVER (PARTITION BY device_id, DATE(order_time) ORDER BY order_time DESC) as rn\n                FROM t_device_oil_order\n                WHERE order_time >= :start_date_param_full AND order_time <= :end_date_param_full\n                AND status = 1\n            ) AS RankedOrders\n            WHERE rn = 1\n        ),\n        DeviceDateSeries AS (\n            -- 步骤5: 为每个设备创建完整的日期序列\n            SELECT\n                ld.device_id,\n                ds.report_date\n            FROM\n                DateSeries ds\n            CROSS JOIN\n                LatestDevices ld\n            WHERE ld.device_code IN :device_codes\n        ),\n        CombinedDailyData AS (\n            -- 步骤6: 合并每日聚合数据到完整日期序列\n            SELECT\n                dds.device_id,\n                dds.report_date,\n                COALESCE(da.daily_order_volume, 0) AS daily_order_volume,\n                COALESCE(da.daily_refill, 0) AS daily_refill,\n                dli.end_of_day_inventory\n            FROM\n                DeviceDateSeries dds\n            LEFT JOIN\n                DailyAggregates da ON dds.device_id = da.device_id AND dds.report_date = da.report_date\n            LEFT JOIN\n                DailyLastInventory dli ON dds.device_id = dli.device_id AND dds.report_date = dli.report_date\n        ),\n        FilledData AS (\n            -- 步骤7: 向前填充缺失的库存数据\n            SELECT\n                device_id,\n                report_date,\n                daily_order_volume,\n                daily_refill,\n                COALESCE(\n                    end_of_day_inventory,\n                    (SELECT f2.end_of_day_inventory FROM CombinedDailyData f2 WHERE f2.device_id = CombinedDailyData.device_id AND f2.report_date < CombinedDailyData.report_date AND f2.end_of_day_inventory IS NOT NULL ORDER BY f2.report_date DESC LIMIT 1)\n                ) AS end_of_day_inventory\n            FROM\n                CombinedDailyData\n        )\n        -- 步骤8: 返回每日的原始计算因子，供Python端进行最终计算\n        SELECT\n            ld.device_code,\n            c.customer_name,\n            ot.oil_model as oil_name,\n            fd.report_date,\n            fd.daily_order_volume,\n            fd.daily_refill,\n            fd.end_of_day_inventory,\n            LAG(fd.end_of_day_inventory, 1, fd.end_of_day_inventory) OVER (PARTITION BY fd.device_id ORDER BY fd.report_date) AS prev_day_inventory\n        FROM\n            FilledData fd\n        JOIN\n            LatestDevices ld ON fd.device_id = ld.device_id\n        JOIN\n            t_customer c ON ld.customer_id = c.id\n        LEFT JOIN \n            t_oil_type ot ON ld.oil_type_id = ot.id\n        WHERE c.status = 1\n        ORDER BY\n            ld.device_code, fd.report_date\n        ",

        "error_summary_offline_query": "\n        WITH LatestDevices AS (\n            -- 步骤1: 找出每个device_code对应的最新的、有效的device_id\n            SELECT \n                id as device_id, \n                device_code,\n                customer_id\n            FROM (\n                SELECT \n                    id, \n                    device_code, \n                    customer_id,\n                    ROW_NUMBER() OVER (PARTITION BY device_code ORDER BY create_time DESC, id DESC) as rn\n                FROM t_device\n                WHERE del_status = 1 AND device_code IS NOT NULL AND device_code != ''\n            ) AS RankedDevices\n            WHERE rn = 1\n        )\n        SELECT\n            ld.device_code,\n            f.create_time,\n            f.recovery_time,\n            f.biz_type\n        FROM\n            t_device_fault_detail f\n        JOIN\n            LatestDevices ld ON f.device_id = ld.device_id\n        WHERE\n            f.fault_type = 9999\n            AND f.create_time <= :end_date_param_full\n            AND (f.recovery_time IS NULL OR f.recovery_time >= :start_date_param_full)\n            AND ld.device_id = :device_id\n        "
    }
}