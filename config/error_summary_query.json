{
    "sql_templates": {
        "error_summary_main_query": "\n        WITH LatestDevices AS (\n            -- 步骤1: 找出每个device_code对应的最新的、有效的device_id\n            SELECT \n                id as device_id, \n                device_code,\n                customer_id\n            FROM (\n                SELECT \n                    id, \n                    device_code, \n                    customer_id,\n                    ROW_NUMBER() OVER (PARTITION BY device_code ORDER BY create_time DESC, id DESC) as rn\n                FROM t_device\n                WHERE del_status = 1 AND device_code IS NOT NULL AND device_code != ''\n            ) AS RankedDevices\n            WHERE rn = 1\n        ),\n        OrderData AS (\n            -- 步骤2: 只获取与最新device_id相关的订单数据，并计算上一条库存\n            SELECT\n                ld.device_code,\n                o.device_id,\n                o.order_time,\n                o.oil_val,\n                o.avai_oil,\n                LAG(o.avai_oil, 1, o.avai_oil) OVER (PARTITION BY o.device_id ORDER BY o.order_time) AS prev_avai_oil\n            FROM\n                t_device_oil_order o\n            JOIN\n                LatestDevices ld ON o.device_id = ld.device_id\n            WHERE\n                order_time >= '{start_date_str} 00:00:00' AND order_time <= '{end_date_str} 23:59:59'\n                AND status = 1 -- 正常订单\n        ),\n        DailyMetrics AS (\n            -- 步骤3.1: 按天聚合计算订单量和推断加油量\n            SELECT\n                device_id,\n                DATE(order_time) AS report_date,\n                SUM(oil_val) AS daily_order_total,\n                SUM(GREATEST(0, avai_oil - prev_avai_oil)) AS daily_refill\n            FROM\n                OrderData\n            GROUP BY\n                device_id, DATE(order_time)\n        ),\n        DailyEndInventory AS (\n            -- 步骤3.2: 获取每日的最后库存值\n            SELECT\n                device_id,\n                DATE(order_time) AS report_date,\n                avai_oil AS end_of_day_inventory\n            FROM (\n                SELECT\n                    device_id,\n                    order_time,\n                    avai_oil,\n                    ROW_NUMBER() OVER (PARTITION BY device_id, DATE(order_time) ORDER BY order_time DESC) as rn\n                FROM OrderData\n            ) AS RankedDevices\n            WHERE rn = 1\n        ),\n        DailyConsumption AS (\n            -- 步骤4: 聚合每日数据，并计算每日库存消耗\n            SELECT\n                dm.device_id,\n                dm.report_date,\n                SUM(dm.daily_order_total) AS daily_order_volume,\n                LAG(MAX(dei.end_of_day_inventory), 1, MAX(dei.end_of_day_inventory)) OVER (PARTITION BY dm.device_id ORDER BY dm.report_date) AS prev_day_end_inventory,\n                MAX(dei.end_of_day_inventory) AS current_day_end_inventory,\n                SUM(dm.daily_refill) AS daily_refill_volume\n            FROM\n                DailyMetrics dm\n            JOIN \n                DailyEndInventory dei ON dm.device_id = dei.device_id AND dm.report_date = dei.report_date\n            GROUP BY\n                dm.device_id, dm.report_date\n        )\n        SELECT\n            ld.device_code,\n            c.customer_name,\n            SUM(dc.daily_order_volume) AS total_order_volume,\n            SUM(\n                (dc.prev_day_end_inventory - dc.current_day_end_inventory) + dc.daily_refill_volume\n            ) AS total_inventory_consumption\n        FROM\n            DailyConsumption dc\n        JOIN\n            LatestDevices ld ON dc.device_id = ld.device_id\n        JOIN\n            t_customer c ON ld.customer_id = c.id\n        WHERE c.status = 1 -- 筛选正常客户\n        GROUP BY\n            ld.device_code, c.customer_name\n        HAVING\n            (total_order_volume != 0 OR total_inventory_consumption != 0) AND -- 有订单或有消耗\n            ABS(total_inventory_consumption - total_order_volume) > 0.01 -- 筛选出有误差的设备\n        ",
        "error_summary_offline_query": "\n        WITH LatestDevices AS (\n            -- 步骤1: 找出每个device_code对应的最新的、有效的device_id\n            SELECT \n                id as device_id, \n                device_code,\n                customer_id\n            FROM (\n                SELECT \n                    id, \n                    device_code, \n                    customer_id,\n                    ROW_NUMBER() OVER (PARTITION BY device_code ORDER BY create_time DESC, id DESC) as rn\n                FROM t_device\n                WHERE del_status = 1 AND device_code IS NOT NULL AND device_code != ''\n            ) AS RankedDevices\n            WHERE rn = 1\n        )\n        SELECT\n            ld.device_code,\n            f.create_time,\n            f.recovery_time,\n            f.biz_type\n        FROM\n            t_device_fault_detail f\n        JOIN\n            LatestDevices ld ON f.device_id = ld.device_id\n        WHERE\n            f.fault_type = 9999\n            AND f.create_time <= %s\n            AND (f.recovery_time IS NULL OR f.recovery_time >= %s)\n        "
    }
}